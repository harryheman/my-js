---
slug: nextjs-redis
title: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü —Å –ø–æ–º–æ—â—å—é –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ Next.js –∏ Redis
description: –¢—É—Ç–æ—Ä–∏–∞–ª –ø–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é —Å—Ç—Ä–∞–Ω–∏—Ü —Å –ø–æ–º–æ—â—å—é –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ Next.js –∏ Redis
authors: harryheman
tags: [javascript, js, next.js, 'nextjs', next, redis, cache, caching, tutorial, —Ç—É—Ç–æ—Ä–∏–∞–ª, –∫–µ—à, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ]
image: https://habrastorage.org/webt/2s/qg/xv/2sqgxvllqf-p6w-a6axpi4l8qfo.png
---

<img src="https://habrastorage.org/webt/2s/qg/xv/2sqgxvllqf-p6w-a6axpi4l8qfo.png" alt="" />

–ü—Ä–∏–≤–µ—Ç, –¥—Ä—É–∑—å—è!

–í –æ–¥–Ω–æ–π –∏–∑ [–ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å—Ç–∞—Ç–µ–π](https://habr.com/ru/company/timeweb/blog/655775/) —è —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é [Imgproxy](https://docs.imgproxy.net/GETTING_STARTED) –∏ –∏—Ö –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —Å –ø–æ–º–æ—â—å—é [—Å–µ—Ä–≤–∏—Å-–≤–æ—Ä–∫–µ—Ä–∞](https://developer.mozilla.org/ru/docs/Web/API/Service_Worker_API). –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —è —Ö–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –≤–∞–º –æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞–∑–º–µ—Ç–∫–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–π [Next.js](https://nextjs.org/), —Å –ø–æ–º–æ—â—å—é [–∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞](https://nextjs.org/docs/advanced-features/custom-server) –∏ [Redis](https://redis.io/), –∞ —Ç–∞–∫–∂–µ –ø–æ–∫–∞–∑–∞—Ç—å –æ–¥–∏–Ω –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–µ–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.

[–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∫–æ–¥–æ–º –ø—Ä–æ–µ–∫—Ç–∞](https://github.com/harryheman/Blog-Posts/tree/master/nextjs-redis).

<!--truncate-->

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

_–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ_: –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç—É—Ç–æ—Ä–∏–∞–ª–∞ –Ω–∞ –≤–∞—à–µ–π –º–∞—à–∏–Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã [Node.js](https://nodejs.org/en/download/) –∏ [Docker](https://www.docker.com/products/docker-desktop/).

–°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é [create-next-app](https://nextjs.org/docs/api-reference/create-next-app):

```bash
# next-redis - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
yarn create next-app next-redis
# or
npx create-next-app next-redis
```

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ–∑–¥–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

```bash
yarn add cron dotenv express redis

yarn add -D nodemon
# or
npm i ...
npm i -D nodemon
```

- [cron](https://www.npmjs.com/package/cron) - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á;
- [dotenv](https://www.npmjs.com/package/dotenv) - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ä–µ–¥—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è;
- [express](https://expressjs.com/ru/) - `Node.js-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫` –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–≤;
- [redis](https://www.npmjs.com/package/redis) - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `Redis`;
- [nodemon](https://www.npmjs.com/package/nodemon) - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

–°–æ–∑–¥–∞–µ–º –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ñ–∞–π–ª `.env` —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:

```bash
# –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
APP_NAME=my-app

# –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è —Å—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
ENV=development

# –≤–µ—Ä—Å–∏—è `Node.js`
NODE_VERSION=16.13.1

# –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `redis`
REDIS_PASSWORD=qwerty

# –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞, —Ö—Ä–∞–Ω—è—â–µ–≥–æ—Å—è –≤ `redis`
VERIFICATION_CODE=super-secret
```

–ù–∞—Å—Ç—Ä–æ–∏–º `Docker-—Å–µ—Ä–≤–∏—Å` –¥–ª—è `redis`.

–°–æ–∑–¥–∞–µ–º –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ñ–∞–π–ª `docker-compose.yml` —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:

```yml
# –≤–µ—Ä—Å–∏—è `Compose`
version: '3.9'
# —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
services:
  # –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
  redis:
    # —Ñ–∞–π–ª, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è
    env_file: .env
    # –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    container_name: ${APP_NAME}_redis
    # –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –æ–±—Ä–∞–∑
    image: bitnami/redis:latest
    # —Ç–æ–º –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    volumes:
      - ./data_redis:/data
    # –ø–æ—Ä—Ç—ã `—Ö–æ—Å—Ç:–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä`
    ports:
      - 6379:6379
    # –ø–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    restart: on-failure
```

–í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É `docker compose up -d` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞.

<img src="https://habrastorage.org/webt/iq/qz/nd/iqqzndfu5-gdm1xvn6hsyrenfxq.png" />
<br />

–ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç `redis` –æ –µ–≥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ä–∞–±–æ—Ç–µ.

–ù–∞ —ç—Ç–æ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã.

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π:

```
components - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  Nav.js - –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
pages - —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  _app.js - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  about.js
  catalog.js
  index.js
public
  favicon.ico
styles
  global.css
```

`components/Nav.js`:

```javascript
/* eslint-disable */
export default function Nav() {
  return (
    <nav>
      <ul>
        <li>
          <a href='/'>Home</a>
        </li>
        <li>
          <a href='/catalog'>Catalog</a>
        </li>
        <li>
          <a href='/about'>About</a>
        </li>
      </ul>
    </nav>
  )
}
```

–û —Ç–æ–º, –ø–æ—á–µ–º—É –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–≥ `a`, –∞ –Ω–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `Link` –∏–∑ –ø–∞–∫–µ—Ç–∞ `next/link`, —Å–º. –Ω–∏–∂–µ.

`pages/index.js`:

```javascript
export default function Home() {
  return <h2>Welcome to Home Page</h2>
}
```

`pages/about.js`:

```javascript
export default function Home() {
  return <h2>This is About Page</h2>
}
```

–≠—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —è–≤–ª—è—é—Ç—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ (dumb/–≥–ª—É–ø—ã–º–∏ –≤ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ [React](https://ru.reactjs.org/)).

`pages/catalog.js`:

```javascript
// –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
const SERVER_URI = process.env.SERVER_URI || 'http://localhost:5000'

// –Ω–∞–ª–∏—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `getServerSideProps` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞
// —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
//
// –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∞—Ç—å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å–ø–∏—Å–æ–∫/–º–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
export async function getServerSideProps() {
  let categories = []

  try {
    const res = await fetch(`${SERVER_URI}/current-categories`)
    categories = await res.json()
  } catch (err) {
    console.error(err)
  }

  return {
    props: {
       categories
    }
  }
}

export default function Catalog({ categories }) {
  return (
    <>
      <h2>This is Catalog Page</h2>
      {/* —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ */}
      <ul>
        {categories.map((category) => (
          <li key={category.id}>{category.title}</li>
        ))}
      </ul>
    </>
  )
}
```

–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ. –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç?

–ù–∞ —Å–∞–º–æ–º –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

- –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –¥–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Ä–≤–µ—Ä—É `next` –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ç–∫–∏ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏;
- —Å–µ—Ä–≤–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ `getServerSideProps` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö;
- —Å–µ—Ä–≤–µ—Ä —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É (—Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ `renderToHtml`);
- –≥–æ—Ç–æ–≤–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏;
- –∫–ª–∏–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—é/–≥–∏–¥—Ä–∞—Ü–∏—é (hydration), –ø—Ä–µ–æ–±—Ä–∞–∑—É—è —Å—Ç—Ä–æ–∫—É –≤ "–Ω–∞—Å—Ç–æ—è—â—É—é" —Ä–∞–∑–º–µ—Ç–∫—É.

`pages/_app.js`:

```javascript
import '../styles/globals.css'
import Nav from '../components/Nav'

function MyApp({ Component, pageProps }) {
  return (
    <div className='app'>
      <header>
        <h1>Next.js + Redis</h1>
        <Nav />
      </header>
      <main>
        <Component {...pageProps} />
      </main>
      <footer>
        <p>&copy; 2022. Not all rights reserved</p>
      </footer>
    </div>
  )
}

export default MyApp
```

–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (`global.css`):

```css
html,
body {
  padding: 0;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen,
    Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;
}

* {
  box-sizing: border-box;
}

.app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  text-align: center;
}

ul {
  margin: 0;
  padding: 0;
  list-style: none;
  display: flex;
  justify-content: center;
  gap: 1rem;
}

a {
  text-decoration: none;
}

main {
  flex-grow: 1;
  display: grid;
  place-content: center;
}
```

–ù–∞ —ç—Ç–æ–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏ –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏, —Ä–∞–¥–∏ –∫–æ—Ç–æ—Ä–æ–π –º—ã, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, –∑–¥–µ—Å—å –∏ —Å–æ–±—Ä–∞–ª–∏—Å—å.

## –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±—É–¥–µ—Ç –Ω–µ–º–Ω–æ–≥–æ —Å–ª–æ–∂–Ω–µ–µ, —á–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è:

```
server
  utils - —É—Ç–∏–ª–∏—Ç—ã
    pageController.js - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü, –ø–æ—Å—Ä–µ–¥–Ω–∏–∫/middleware –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å `redis`
    renderPage.js - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
  index.js - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å–µ—Ä–≤–µ—Ä–∞
```

–ù–∞—á–Ω–µ–º —Å —É—Ç–∏–ª–∏—Ç.

`utils/renderPage.js`:

```javascript
async function renderPage(app, req, res) {
  // –æ–±—ä–µ–¥–∏–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å—Ç—Ä–æ–∫—É –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
  const query = { ...req.params, ...req.query }

  try {
    // —Ä–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const html = await app.renderToHTML(req, res, req.path, query)

    // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–µ –≤ `redis`
    // –¥–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–æ–º
    res.saveHtmlToCache(html)

    // –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É
    res.send(html)
  } catch (err) {
    console.error(err)

    // —Ä–µ–Ω–¥–µ—Ä–∏–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—à–∏–±–∫–∏
    await app.renderError(err, req, res, req.path, query)
  }
}

module.exports = renderPage
```

`utils/pageController.js`.

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å `redis`, –ø–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ä–µ–¥—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è, —Ñ–æ—Ä–º–∏—Ä—É–µ–º `url` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É `redis` –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ `redis`

```javascript
const redis = require('redis')
require('dotenv').config()

const redisConfig = {
  // –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–∏–º–≤–æ–ª `:` –ø–æ—Å–ª–µ `//`
  // –±–µ–∑ –Ω–µ–≥–æ –±—É–¥–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `invalid user-password pair`
  url: `redis://:${process.env.REDIS_PASSWORD}@${process.env.REDIS_HOST || 'localhost'}:6379`
}

async function createClient() {
  // —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ `redis`
  const client = redis.createClient(redisConfig)

  // —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  client.on('error', (err) => {
    console.error('@redis error', err)
  })

  client.on('connect', () => {
    console.log('@redis connect')
  })

  client.on('reconnecting', () => {
    console.log('@redis reconnecting')
  })

  client.on('end', () => {
    console.log('@redis disconnect')
  })

  try {
    // –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É `redis`
    await client.connect()
  } catch (err) {
    console.error(err)
  }

  // –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
  return client
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ `redis` –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞:

```javascript
let redisClient

async function pageController(req, res, next) {
  // —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ `redis` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏
  if (!redisClient) {
    try {
      redisClient = await createClient()
    } catch (err) {
      console.error(err)
    }
  }

  console.log('@redis middleware', req.path)

  // –∫–ª—é—á –¥–ª—è –∫–µ—à–∞
  const cacheKey = req.path

  try {
    // –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É –∏–∑ –∫–µ—à–∞
    const html = await redisClient.get(cacheKey)

    // –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å
    if (html) {
      console.log('@from cache')

      // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É –∫–ª–∏–µ–Ω—Ç—É
      // –Ω–∞ —ç—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è,
      // —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
      return res.send(html)
    }

    // —Ä–∞—Å—à–∏—Ä—è–µ–º –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–µ–π –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–∞–∑–º–µ—Ç–∫–∏ –≤ –∫–µ—à
    res.saveHtmlToCache = (html) => {
      console.log('@to cache')

      redisClient.set(cacheKey, html).catch(console.error)
    }

    // —Ä–∞—Å—à–∏—Ä—è–µ–º –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–µ–π –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞
    res.clearCache = () => {
      console.log('@clear cache')

      // –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –æ—á–∏—â–∞–µ—Ç—Å—è –≤–µ—Å—å –∫–µ—à, —Ö—Ä–∞–Ω—è—â–∏–π—Å—è –≤ `redis`
      // –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–µ—à–∞ –ø–æ –∫–ª—é—á—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `redisClient.del(cacheKey)`
      redisClient.flushAll().catch(console.error)
    }

    // –ø–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É –∑–∞–ø—Ä–æ—Å–∞
    next()
  } catch (err) {
    console.error(err)
  }
}

module.exports = pageController
```

–¢–µ–ø–µ—Ä—å —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å–µ—Ä–≤–µ—Ä–∞ (`index.js`).

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ —É—Ç–∏–ª–∏—Ç—ã, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫/–º–∞—Å—Å–∏–≤ –∫–µ—à–∏—Ä—É–µ–º—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ä–µ–¥—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Å–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–µ—Ä–∞ `next` –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤:

```javascript
const next = require('next')
const express = require('express')

const pageController = require('./utils/pageController')
const renderPage = require('./utils/renderPage')

// –∫–µ—à–∏—Ä—É–µ–º—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const CACHED_PAGES = ['/', '/catalog', '/about']

// —Å—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
const dev = process.env.ENV === 'development'

// —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–µ—Ä–∞
const app = next({ dev })

// –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
const handle = app.getRequestHandler()
```

–í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤:

```javascript
app.prepare().then(() => {
  // —Å–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `express`
  const server = express()

  // –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏
  server.use(express.static('static'))

  // –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏
  server.get('/_next/*', handle)

  server.get('/favicon.ico', handle)

  // –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ `GET-–∑–∞–ø—Ä–æ—Å—ã`
  // –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å `redis`
  server.get('*', pageController, (req, res) => {
    console.log('@route handler', req.path)

    // –µ—Å–ª–∏ –ø–æ—Å—Ç—É–ø–∏–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—á–∏—Å—Ç–∫—É –∫–µ—à–∞
    if (req.path === '/clear-cache') {
      // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `x-verification-code` —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è `super-secret`
      // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç–∫—É–¥–∞-—Ç–æ –∏–∑–≤–Ω–µ
      // –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –æ–¥–Ω–æ–º –∏–∑ –º–æ–∏—Ö —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ç–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å
      // –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç "–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ" —Å–µ—Ä–≤–µ—Ä–∞, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞ `Python`
      if (
        req.headers['x-verification-code'] &&
        req.headers['x-verification-code'] !== process.env.VERIFICATION_CODE
      ) {
        // –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `super-secret`
        return res.sendStatus(403)
      }

      // –æ—á–∏—â–∞–µ–º –∫–µ—à
      res.clearCache()

      return res.sendStatus(200)
    }

    // –µ—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∫–µ—à–∏—Ä—É–µ–º–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    if (CACHED_PAGES.includes(req.path)) {
      // –≤—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É —É—Ç–∏–ª–∏—Ç—É
      return renderPage(app, req, res)
    }

    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    return handle(req, res)
  })

  // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—Ç
  const port = process.env.PORT || 5000

  // –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
  server.listen(port, (err) => {
    if (err) return console.error(err)

    console.log(`üöÄ Server ready on port ${port}`)
  })
})
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ —Ä–∞–∑–¥–µ–ª–µ `scripts` —Ñ–∞–π–ª–∞ `package.json` –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ `next` –≤ —Ä–µ–∂–∏–º–∞—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø—Ä–æ–¥–∞–∫—à–Ω–∞:

```json
"start:dev": "ENV=development nodemon server/index.js",
"start": "ENV=production node server/index.js"
```

–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `yarn start:dev` –∏–ª–∏ `npm run start:dev` –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:5000`.

<img src="https://habrastorage.org/webt/2i/lp/io/2ilpiofzfnki2pyaclmwkjmsths.png" />
<br />

_–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ_ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ: –º—ã –≤–∏–¥–∏–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (`/`) –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–Ω–∞—á–∞–ª–∞ —á–µ—Ä–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `redis` (`@redis middleware /`), –∑–∞—Ç–µ–º —á–µ—Ä–µ–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ (`@route handler /`). –¢–∞–∫–∂–µ –º—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç `redis` –æ –∑–∞–ø–∏—Å–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∫–µ—à (`@to cache`).

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É, –Ω–∞–ø—Ä–∏–º–µ—Ä, `About`.

<img src="https://habrastorage.org/webt/fi/wu/sj/fiwusj43cgunijmci16lovutki4.png" />
<br />

–ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é.

<img src="https://habrastorage.org/webt/pe/2r/yx/pe2ryxyuya9f9fddczi7onbkkow.png" />
<br />

–ù–∞ —ç—Ç–æ—Ç —Ä–∞–∑ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞ (`@redis middleware /`), –∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ –∫–µ—à–∞ (`@from cache`). –ü—Ä–µ–∫—Ä–∞—Å–Ω–æ, —ç—Ç–æ –∫–∞–∫ —Ä–∞–∑ —Ç–æ, –∫ —á–µ–º—É –º—ã —Å—Ç—Ä–µ–º–∏–ª–∏—Å—å.

–í–µ—Ä–Ω–µ–º—Å—è –∫ —Ç–æ–º—É, –ø–æ—á–µ–º—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ç–µ–≥ `a` –≤–º–µ—Å—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `Link`. –î–µ–ª–æ –≤ —Ç–æ–º, —á—Ç–æ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `Link` –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å `/` –Ω–∞ `/about`, `/about` –Ω–µ –±—É–¥–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å—Å—è (—Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥—É—Ç –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å—Å—è –ª–∏–±–æ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞, –ª–∏–±–æ –ø—Ä–∏ –ø—Ä—è–º–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É). –í—ã –º–æ–∂–µ—Ç–µ —Å–∞–º–∏ –≤ —ç—Ç–æ–º —É–±–µ–¥–∏—Ç—å—Å—è, –∑–∞–º–µ–Ω–∏–≤ `a` –Ω–∞ `Link` –≤ —Ñ–∞–π–ª–µ `components/Nav.js`.

## –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü

–û–¥–Ω–∞ –∏–∑ –ø—Ä–æ–±–ª–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ—Å—Ç–æ–∏—Ç –≤ —Ç–æ–º, —á—Ç–æ —Ç–∞–∫–æ–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–ª—É—á–∞–µ, –∫–æ–≥–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å `getServerSideProps` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö, —Ö—Ä–∞–Ω—è—â–∏—Ö—Å—è –≤ –±–∞–∑–µ.

–í –æ–¥–Ω–æ–º –∏–∑ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —è —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å —Ç–µ–º, —á—Ç–æ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ `_app.js` –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –æ–≥—Ä–æ–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö. –û—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∑–∞–Ω–∏–º–∞–ª –¥–æ `10` (sic) —Å–µ–∫—É–Ω–¥. –í—Å–µ —ç—Ç–æ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤–ø–µ—Ä–≤—ã–µ –ø—Ä–∏—à–µ–¥—à–∏–π –Ω–∞ —Å–∞–π—Ç, –ª—é–±–æ–≤–∞–ª—Å—è –±–µ–ª—ã–º —ç–∫—Ä–∞–Ω–æ–º –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (–ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏ —Å–∞–π—Ç–∞ –∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–∞–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –±—ã–ª–æ –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞ `next` –∏ `python-—Å–µ—Ä–≤–µ—Ä–∞—Ö`). –°–∞–º–∏ –ø–æ–Ω–∏–º–∞–µ—Ç–µ, —á—Ç–æ —Ç–∞–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –º–µ–Ω—è, –º—è–≥–∫–æ –≥–æ–≤–æ—Ä—è, –Ω–µ –æ—á–µ–Ω—å —É—Å—Ç—Ä–∞–∏–≤–∞–ª–∞. –ü—Ä–∏ —ç—Ç–æ–º —è –Ω–µ –º–æ–≥ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é `limit` –∏ `offset`) –±–µ–∑ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö —Å–≤–æ–π—Å—Ç–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (—á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –æ—Ç–≤–µ—Ç–∞).

–ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —è –ø—Ä–∏—à–µ–ª –∫ —Å–ª–µ–¥—É—é—â–µ–º—É:

- –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞;
- –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î;
- –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (–∫–∞–∂–¥—ã–µ 20 –º–∏–Ω—É—Ç) –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏—Ö –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏.

–†–µ–∞–ª–∏–∑—É–µ–º —ç—Ç–æ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (`categories`) –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ (`Catalog`, `catalog.js`). –î–ª—è —ç—Ç–æ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–∞–π–ª–µ `server/index.js`.

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ç–∏–ª–∏—Ç—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `cron`:

```javascript
const { CronJob } = require('cron')
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π:

```javascript
const DEFAULT_CATEGORIES = [
  {
    id: 1,
    title: 'First category',
    products: []
  },
  {
    id: 2,
    title: 'Second category',
    products: []
  },
  {
    id: 3,
    title: 'Third category',
    products: []
  }
]

let allCategories = []
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –≤—ã–∑—ã–≤–∞–µ–º –µ–µ:

```javascript
async function updateCategories() {
  try {
    const categories = await Promise.resolve(DEFAULT_CATEGORIES)
    // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —è–∫–æ–±—ã –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ –ë–î, –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    allCategories = categories
  } catch (err) {
    console.error(err)
  }
}
updateCategories()
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º `cron-–∑–∞–¥–∞—á—É` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫–∞–∂–¥—ã–µ 20 –º–∏–Ω—É—Ç:

```javascript
const cronJobForCategories = new CronJob(
  '0/20 * * * *',
  updateCategories,
  null,
  false,
  'Europe/Moscow'
)
```

–°–∏–≥–Ω–∞—Ç—É—Ä–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ `Cron`:

```javascript
constructor(cronTime, onTick, onComplete, start, timezone)
```

- `cron: string` - –≤—Ä–µ–º—è –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ ([–æ–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä](https://crontab.guru/)). –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ "—Ä–∞–±–æ—Ç–∞" –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 20 –º–∏–Ω—É—Ç;
- `onTick: function` - —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞–µ–º–∞—è –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ "—Ä–∞–±–æ—Ç—ã";
- `onComplete: function?` - —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞–µ–º–∞—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã (—Å–∏–º–≤–æ–ª `?` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä —è–≤–ª—è–µ—Ç—Å—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º);
- `start?: boolean` - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞ "—Ä–∞–±–æ—Ç—ã" –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è;
- `timezone?: string` - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –∏ —Ç.–¥. –° –ø–æ–ª–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–æ–∂–Ω–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è [–∑–¥–µ—Å—å](https://www.npmjs.com/package/cron#api).

–ù–∞–∫–æ–Ω–µ—Ü, –∑–∞–ø—É—Å–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ "—Ä–∞–±–æ—Ç—ã" –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ:

```javascript
server.listen(port, (err) => {
  if (err) return console.error(err)

  console.log(`üöÄ Server ready on port ${port}`)
})

// !
if (!dev) {
  cronJobForCategories.start()
}
```

–û—Ç–ª–∏—á–Ω–æ, –¥–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞–º–∏ —Ç–∞–∫–∂–µ —É—Å–ø–µ—à–Ω–æ —Ä–µ—à–µ–Ω–∞.

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å—á–∞—Å—Ç—å—è –Ω–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏" `Next-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`. –î–∞–≤–∞–π—Ç–µ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–º.

–°–æ–∑–¥–∞–µ–º –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ñ–∞–π–ª `Dockerfile` —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:

```dockerfile
# –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è `Node.js`
ARG NODE_VERSION=16.13.1

# –æ–±—Ä–∞–∑
FROM node:${NODE_VERSION}

# —Ä–∞–±–æ—á–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /app

# –∫–æ–ø–∏—Ä—É–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
COPY package.json yarn.lock ./

# —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN yarn

# –∫–æ–ø–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
COPY . .

# –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
RUN yarn build

# –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
CMD ["yarn", "start"]
```

–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª `docker-compose.yml`:

```yml
version: '3.9'
services:
  next:
    env_file: .env
    # —ç—Ç–æ –≤–∞–∂–Ω–æ: –Ω–∞–∑–≤–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞ `redis` –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
    environment:
      - REDIS_HOST=redis
    container_name: ${APP_NAME}_next
    # –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏
    build: .
    ports:
      - 5000:5000
    restart: on-failure

  redis:
    env_file: .env
    container_name: ${APP_NAME}_redis
    image: bitnami/redis:latest
    volumes:
      - ./data_redis:/data
    ports:
      - 6379:6379
    restart: on-failure
```

–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å–µ—Ä–≤–∏—Å:

```bash
docker compose stop
docker compose rm
```

–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å —Å –ø–æ–º–æ—â—å—é `docker compose up -d`.

<img src="https://habrastorage.org/webt/xg/_z/g2/xg_zg2abwbsxc572yano3tcptuq.png" />
<br />

–û—Ç–ø—Ä–∞–≤–ª—è–µ–º `GET-–∑–∞–ø—Ä–æ—Å` –∫ `http://localhost:5000/clear-cache` —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `x-verification-code: super-secret` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é [Insomnia](https://insomnia.rest/download).

<img src="https://habrastorage.org/webt/5q/7y/sy/5q7ysyja0maxdvep0jbhogkch64.png" />
<br />

–ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—á–∏—Å—Ç–∫–µ –∫–µ—à–∞ –æ—Ç `redis` (`@clear cache`).

–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

<img src="https://habrastorage.org/webt/pm/xj/zh/pmxjzhzaaelo0_dtym_uo3-fdcs.png" />
<br />

–ö—Ä—É—Ç–æ! –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è.

_–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ_: –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ª–µ–¥—É–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ. –î–ª—è —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `const isProd = process.env.ENV === 'production'`, –Ω–∞–ø—Ä–∏–º–µ—Ä.

–ü–æ–∂–∞–ª—É–π, —ç—Ç–æ –≤—Å–µ, –æ —á–µ–º —è —Ö–æ—Ç–µ–ª —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –≤–∞–º –≤ —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ.

–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ happy coding!